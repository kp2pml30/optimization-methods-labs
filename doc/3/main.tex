\documentclass[russian, english]{article}

\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english, main=russian]{babel}
\usepackage{amsmath}
\usepackage{pgfplots}
\usepackage{graphicx}
\usepackage{csvsimple}
\usepackage{hyperref}
\usepackage{textgreek}

\DeclareUnicodeCharacter{0394}{Delta}
\DeclareUnicodeCharacter{03B5}{epsilon}

\inputencoding{utf8}
\def\code#1{\texttt{#1}}
\newcommand{\mydot}[2]{\left\langle#1,#2\right\rangle}

\newcommand{\FastTable}[1]{
	\begin{center}
	\csvautotabular[separator=tab]{#1}
	\end{center}
}

\begin{document}
\begin{titlepage}
\centering
	{\scshape\LARGE Методы оптимизации \par}
	\vspace{1cm}
	{\scshape\Large Лабораторная работа №3\par}
	\vspace{2cm}
	{\Large\itshape Дмитрий Проценко M3234 \par
	Кирилл Прокопенко M3236 \par
	Николай Холявин M3238 \par}
	\vfill
	ИТМО y2019
	\vfill
	{\large \today\par}
\end{titlepage}

\tableofcontents
\newpage

\section{Цели}
\begin{itemize}
	\item реализовать $LU$ разложение и решение систем линейных уравнений на его основе
	\item оценить зависимость погрешности от числа обусловленности, размерности (на сгенерированных с диагональным преобладанием, матрицах Гильберта)
	\item сравнить с другими методами (Гаусса)
	\item реализовать профильный формат хранения матрицы
	\item реализовать метод сопряженных градиентов для решения систем линейных уравнений
\end{itemize}
\section{Теория}
\subsection{Обозначения}
Рассматривается решение системы $Ax=f$ \\
$\|\cdot\|$ --- Евклидова норма
\subsection{Профильный формат матрицы}
Данный формат позволяет хранить квадратные матрицы: отдельно хранится главная диагональ и 2 треугольника, при этом треугольники хранятся в следующем формате: нжний левый хранится по строкам, верхний правый по столбцам, индексы первых элементов соответствующийх линий совпадают. Для улучшения кэширования и уменьшения фрагментации памяти каждый треугольник имеет общую память.\\
Это может выглядеть, например, так:

\newcommand*{\GridSize}{8}

\newcommand*{\ColorCells}[1]{% #1 = list of x/y/color
	\foreach \x/\y/\color in {#1} {
		\node [fill=\color, draw=none, thick, minimum size=1cm] 
			at (\x-.5,\GridSize+0.5-\y) {};
	}
}

\newcommand*{\ColorCellsdxdy}[4]{% #4 = list of x/y/color
	\foreach \myi in {1,2,...,#1}{
		\foreach \x/\y/\color in {#4} {
			\node [fill=\color, draw=none, thick, minimum size=1cm] 
				at (\myi*#2-#2+\x-.5,\myi*#3-#3+\GridSize+0.5-\y) {};
		}
	}
}
\begin{center}
\begin{tikzpicture}[scale=1]
	\begin{scope}[thick,local bounding box=name]
		% \ColorCells{1/1/blue, 2/3/red, 3/2/green, 4/4/yellow}
		\ColorCellsdxdy{\GridSize}{1}{-1}{1/1/red}
		\ColorCellsdxdy{3}{1}{0}{2/5/blue}
		\ColorCellsdxdy{3}{0}{-1}{5/2/blue}
		\ColorCellsdxdy{5}{1}{0}{1/6/green}
		\ColorCellsdxdy{5}{0}{-1}{6/1/green}
		\ColorCellsdxdy{2}{1}{0}{6/8/purple}
		\ColorCellsdxdy{2}{0}{-1}{8/6/purple}
		\draw (0, 0) grid (\GridSize, \GridSize);
	\end{scope}
\end{tikzpicture}
\end{center}
Белые клетки --- нули, красные --- диагональ, одинакоые цвета показывают соответсвующие профили матрицы.\par
Данное представление хорошо подходит для $LU$ разложения, поскольку в его алгоритме вычисляются скалярные произведения строк на столбцы с равными индексами. Такой формат минимизирует число перемножений нулей и является оптимальным по кэшу для описанной операции.

\subsection{LU разложение}

\def\opn#1{\operatorname{#1}}
\newcommand{\mtop}[1]{%
\begin{tikzpicture}[#1]%
\draw (0,1.5ex) -- (1.5ex,0);%
\draw (1.5ex,0) -- (1.5ex,1.5ex);%
\draw (0,1.5ex) -- (1.5ex,1.5ex);%
\end{tikzpicture}%
}

\newcommand{\mbottom}[1]{%
\begin{tikzpicture}[#1]%
\draw (0,0) -- (1.5ex,0);%
\draw (1.5ex,0) -- (0,1.5ex);%
\draw (0,0) -- (0,1.5ex);%
\end{tikzpicture}%
}

$A=LU$\\
$U = \mtop{}$, \textbf{не} включает дагональ\\
$L = \mbottom{}$, включает диагональ\\
$L_{1, 1} = A_{1, 1}$\\
$\forall i:\; U_{i, i} = 1$\\
$\forall i\in\overline{2\dots n}: \forall j\in\overline{1\dots i-1}:$
$\begin{cases}
	L_{i,j} = A_{i, j} - \mydot{\opn{row}_L(i)}{\opn{col}_U(j)}\\
	U_{j,i} = \frac{A_{i, j} - \mydot{\opn{row}_L(j)}{\opn{col}_U(i)}}{L_{j, j}}\\
\end{cases}$\\

Для оптимизации объема выделяемой памяти результат складывается в матрицу $A$. Это возможно, поскольку на каждом шаге мы используем только ``старые'' значения матриц $L$ и $U$ и текущее значение матрицы $A$. Профильный формат хранения матрицы позволяет ``обрезать'' нули по краям строк и столбцов.

\section{Исследование погрешности}
\subsection{Диагональное преобладание}
\label{DiagonalPrMatrix0}
Исследуем зависимость погрешности от числа обусловленности ($k$) и размерности пространства ($n$). Для этого будем генерировать матрицы коэффициентов за счет изменени диагонального преобладания для систем вида $A_kx_k=f_k$ следующим образом:\\
$\forall i\neq j:\; A_{i, j}\in\left\{0, -1, -2, -3, -4\right\}$\\
$A_{i,i}=\begin{cases}
-\sum_{i\neq j}A_{i, j} & i > 1\\
-\sum_{i\neq j}A_{i, j} + 10^{-k} & i = 1\\
\end{cases}$\\
Для оценки погрешности будем генерировать системы с заранее известным ответом: $f_k=A\cdot (1,\dots,n)^T$\\

\FastTable{test/out/diag/LU.tsv}

Можно заметить что погрешность крайне мала, что неудивительно, ведь мы находим точное решение. Она практически не зависит от $k$: порядок числа не меняется, числа находятся в диапазоне минимальных представимых в использованных типах. С изменением размерности пространства погрешность растет более существенно, что связано просто с тем как работает дробная арифметика на ЭВМ, ведь периодические дроби непредставимы в типе \texttt{double}.
\subsection{Скачкообразная погрешность}
\subsection{Матрицы Гильберта}
\label{Hilbert}
$\forall i,j\in\overline{1\dots n}:\; A_{i,j}=\frac{1}{i+j-1}$

Их число обусловленности растет как $O\left(\frac{(1+\sqrt{2})^{4n}}{\sqrt{n}}\right)$ согласно Википедии.\\

%В данной работе из матрицы Гильберта берется несколько диагоналей (главная и восемь), поскольку так сказал делать преподаватель.

\FastTable{test/out/hilbert/LU.tsv}

Матрицы Гильберта плохо обусловленные, что влечет большую погрешность.

\section{Метод Гаусса}
\subsection{Диагональное преобладание}
\hyperref[DiagonalPrMatrix0]{Определение было дано выше}.
\FastTable{test/out/diag/Gauss.tsv}
\subsection{Матрицы Гильберта}
\hyperref[Hilbert]{Определение было дано выше}.
\FastTable{test/out/hilbert/Gauss.tsv}

\section{Сравнение количества действий}
Для сравнения будем использовать плотные матрицы Гильберта, чтобы не было случайности и оптимизации из-за профильного формата хранения. Каждая операция считается за единицу, разное количество тактов не учитывается. Для замера был реализован класс, перед каждой операцией увиличивающий соответсвующий счетчик.


\def\makePlots#1#2{
	%\pgfplotstableread{#1}{\ratiosCsv}
		\addplot+ table [x={n}, y={i}] {#1};
		\addlegendentry{#2}
}

\begin{tikzpicture}[trim axis left]
	\begin{axis}[
		scale only axis,
		width=\textwidth,
		legend style={at={(0.5,-0.1)},anchor=north},
		xlabel = {n},
		ylabel = {число действий},
	]
		\makePlots{test/out/complexity/LU.tsv}{LU}
		\makePlots{test/out/complexity/Gauss.tsv}{Гаусс}
		\makePlots{test/out/complexity/ConjGrad.tsv}{Метод сопряженных градиентов}
		\addplot[domain=0:1284] {x^3 * 0.670314};
		\addlegendentry{$0.670314x^3$}
	\end{axis}
\end{tikzpicture}

\section{Метод сопряженных градиентов}
\subsection{Алгоритм}
\begin{itemize}
	\item[обозначение] $\forall v:\; v^2\equiv \mydot{v}{v}$
	\item[подготовка]
		\begin{enumerate}
			\item выберем начальное приближение $x_0$, например, из всех единиц
			\item $r_0 = f - Ax_0$
			\item $z_0 = r_0$
		\end{enumerate}
	\item[цикл]
		\begin{enumerate}
			\item $\alpha_k=\frac{r_{k-1}^2}{\mydot{Az_{k-1}}{z_{k-1}}}$
			\item $x_k=x_{k-1}+\alpha_kz_{k-1}$
			\item $r_k=r_{k-1}-\alpha_kAz_{k-1}$
			\item $\beta_k=\frac{r_k^2}{r_{k-1}^2}$
			\item $z_k=r_k+\beta_kz_{k-1}$
		\end{enumerate}
\end{itemize}
\subsection{Матрица с диагональным преобладанием, версия 1}
\label{DiagonalPrMatrix}
$\forall i\neq j:\; A_{i, j}\in\left\{0, -1, -2, -3, -4\right\}$\\
$A_{i,i}=\begin{cases}
-\sum_{i\neq j}A_{i, j}, & i > 1\\
-\sum_{i\neq j}A_{i, j} + 1, & i = 1\\
\end{cases}$\\
$\operatorname{cond}(A) \ge \frac{\|x-x^*\|}{\|x^*\|}\div\frac{\|f-Ax\|}{\|f\|}$, первая дробь --- относительная погрешность, вторая --- невязка.
\FastTable{test/out/conj_diag/ConjGrad.tsv}

\subsection{Матрица с диагональным преобладанием, версия 2}
$\forall i\neq j:\;A_{i, j}\leftarrow -A_{i, j}$, из \hyperref[DiagonalPrMatrix]{первой версии}.
\FastTable{test/out/conj_diag_rev/ConjGrad.tsv}

\subsection{Плотная матрица Гильберта}
Определение было дано \hyperref[Hilbert]{выше}.\\
\FastTable{test/out/conj_hilbert/ConjGrad.tsv}

\section{Вывод}

\newpage
\appendix
\section{Код}
Код матриц, $LU$ разложения и вся математика находится в директории \texttt{include/math} под говорящими названиями.
\subsection{Ссылки}
\url{https://github.com/kp2pml30/optimization-methods-labs}
\end{document}

